function showMapAndRoute(destination) {
    // Initialize map if not already created
    if (!map) {
        map = L.map('map').setView([51.505, -0.09], 13); // Default view
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        mapContainer.style.display = 'block'; // Show map
    }

    // Get user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const userPos = [userLat, userLng];
                L.marker(userPos).addTo(map).bindPopup('Your Location').openPopup();
                map.setView(userPos, 13);

                // Fetch route from OpenRouteService
                fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=API_KEY_PLACEHOLDER&start=${userLng},${userLat}&end=${destination[0]},${destination[1]}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.features && data.features.length > 0) {
                            const route = data.features[0].geometry.coordinates;
                            const latLngs = route.map(coord => [coord[1], coord[0]]);
                            L.polyline(latLngs, { color: 'blue' }).addTo(map);
                            map.fitBounds(L.polyline(latLngs).getBounds());
                            L.marker([destination[1], destination[0]]).addTo(map).bindPopup('Destination').openPopup();
                        } else {
                            errorMessage.textContent = 'No route found to this destination.';
                            errorMessage.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        errorMessage.textContent = 'Error fetching route. Please try again.';
                        errorMessage.style.display = 'block';
                        console.error('Routing error:', error);
                    });
            },
            error => {
                console.error('Geolocation error:', error.message, 'Code:', error.code);
                errorMessage.textContent = `Unable to retrieve your location: ${error.message}. Using default location.`;
                errorMessage.style.display = 'block';
                // Use default location (London)
                const defaultPos = [51.505, -0.09];
                L.marker(defaultPos).addTo(map).bindPopup('Default Location (London)').openPopup();
                map.setView(defaultPos, 13);

                // Fetch route from default location
                fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=API_KEY_PLACEHOLDER&start=-0.09,51.505&end=${destination[0]},${destination[1]}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.features && data.features.length > 0) {
                            const route = data.features[0].geometry.coordinates;
                            const latLngs = route.map(coord => [coord[1], coord[0]]);
                            L.polyline(latLngs, { color: 'blue' }).addTo(map);
                            map.fitBounds(L.polyline(latLngs).getBounds());
                            L.marker([destination[1], destination[0]]).addTo(map).bindPopup('Destination').openPopup();
                        } else {
                            errorMessage.textContent = 'No route found to this destination.';
                            errorMessage.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        errorMessage.textContent = 'Error fetching route. Please try again.';
                        errorMessage.style.display = 'block';
                        console.error('Routing error:', error);
                    });
            }
        );
    } else {
        errorMessage.textContent = 'Geolocation is not supported by this browser.';
        errorMessage.style.display = 'block';
    }
}
